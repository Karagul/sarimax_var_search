---
title: "R Notebook"
output: html_notebook
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = TRUE, cache = FALSE)
library(here)
# here::here()
knitr::opts_knit$set(root.dir = here::here())
```

```{r load_libs_sources, message=FALSE, warning=FALSE, cache=FALSE, echo=FALSE}
source('./R/utils_av.R')
```


## Initial data


```{r preferences_and_load_data, warning=FALSE}
arima_res_suffix <- "_min"
arima_rds_path = "data/sarimax_objects_"
country_name <- "Bolivia_activ"
# data_path <- "./data/excel/Chile.xlsx"
data_path <- paste0("./data/excel/", country_name, ".xlsx")
external_data_path <- "./data/external/external_us.xlsx"
final_forecast_horizon <- c(2019, 12)
h_max <-  8 # last rgdp data is 2017 Q4
test_length <- h_max
number_of_cv = 8
train_span = 16
use_demetra <- TRUE

use_dm_force_constant <- TRUE
is_log_log <- TRUE
lambda_0_in_auto <- FALSE
mean_logical_in_auto <- TRUE
max_x_lag <- 2

all_arima_data <- ts_data_for_arima(data_path = data_path, 
                                    external_data_path = external_data_path,
                                    all_logs = is_log_log)

this_rgdp_ts <- all_arima_data[["rgdp_ts"]]
this_rgdp_ts <- na.omit(this_rgdp_ts)

this_internal_monthly_ts <- all_arima_data[["monthly_ts"]]
this_external_monthly_ts <- all_arima_data[["external_monthly_ts"]]

internal_monthly_names <- colnames(this_internal_monthly_ts)
external_monthly_names <- colnames(this_external_monthly_ts)

```

Log transformation applied to all variables. Data obtained from the excel file `r print(data_path)` 

### Quarterly real GDP


```{r plot_rgdp}

autoplot(this_rgdp_ts) + 
  ggtitle(paste("Quarterly GDP")) 

```

```{r gr_rgdp_data}
this_rgdp_tsb <- tsibble::as_tsibble(this_rgdp_ts)

seas_gr <- this_rgdp_tsb 

difflog_gr <- diff.xts(this_rgdp_tsb$value, lag = 4, na.pad = TRUE)

gr  <- diff.xts(exp(this_rgdp_tsb$value), lag = 4, na.pad = TRUE) / lag.xts(exp(this_rgdp_tsb$value), k = 4)

seas_gr$difflog_gr <- difflog_gr 
seas_gr$gr <- gr 

# seas_gr <- seas_gr %>% 
#   mutate(d2 = diff(value, lag = 4) )

as_tibble(seas_gr)

```



## Initial GDP specification and forecast

## Forecasting and extending monthly data

### Implied


---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = TRUE, cache = FALSE)
library(here)
# here::here()
knitr::opts_knit$set(root.dir = here::here())
```

```{r load_libs_sources, message=FALSE, warning=FALSE, cache=FALSE, echo=FALSE}
source('./R/utils_av.R')
```

```{r new_functions}

seas_yr_growth <- function(data_ts, freq = 4 , is_log = TRUE, 
                           do_just_log = FALSE) {
  
  seas_gr <- tsibble::as_tsibble(data_ts)
  
  if (is_log) {
    seas_gr  <- seas_gr %>% 
    mutate(difflog_gr =  100 * difference(value, lag = freq))
    
    year_gr <- seas_gr %>% index_by(year_index = year(index)) %>%
      summarise(y_logdiff = mean(difflog_gr, na.rm = TRUE)) 
    
    if (freq == 12) {
      quarter_gr <- seas_gr %>% index_by(quarter_index = yearquarter(index)) %>%
      summarise(q_logdiff = mean(difflog_gr, na.rm = TRUE)) 
    }
    
      if (! do_just_log) {
        seas_gr  <-seas_gr  %>% 
          mutate(gr = 100 * difference(exp(value), lag = freq) / 
                 dplyr::lag(exp(value), n = freq))
        
        year_gr <- seas_gr %>% index_by(year_index = year(index)) %>%
          summarise(y_logdiff = mean(difflog_gr, na.rm = TRUE),
                    y_ave_gr = mean(gr, na.rm = TRUE),
                    y_rgdp = sum(exp(value), na.rm = TRUE))  %>%
          mutate(y_tot_gr = 100*difference(y_rgdp)/lag(y_rgdp)) 
        
        if (freq == 12) {
          quarter_gr <- seas_gr %>% index_by(quarter_index = yearquarter(index)) %>%
          summarise(q_logdiff = mean(difflog_gr, na.rm = TRUE),
                    q_ave_gr = mean(gr, na.rm = TRUE),
                    q_rgdp = sum(exp(value), na.rm = TRUE))  %>%
          mutate(q_tot_gr = 100*difference(q_rgdp, lag = 4)/lag(q_rgdp, n = 4))
          
        }
      }
    
  } else {
    seas_gr  <-seas_gr  %>% 
          mutate(gr = 100 * difference(value, lag = freq) / 
                 dplyr::lag(value, n = freq))
    
    year_gr <- seas_gr %>% index_by(year_index = year(index)) %>% 
      summarise(y_ave_gr = mean(gr, na.rm = TRUE),
                y_rgdp = sum(value)) %>%
      mutate(y_tot_gr = 100*difference(y_rgdp)/lag(y_rgdp))
    
    if (freq == 12) {
      quarter_gr <- seas_gr %>% index_by(quarter_index = yearquarter(index)) %>% 
      summarise(q_ave_gr = mean(gr, na.rm = TRUE),
                q_rgdp = sum(value)) %>%
      mutate(q_tot_gr = 100*difference(q_rgdp, lag = 4)/lag(q_rgdp, n = 4))
    }
    
  }

  
  if (freq == 4) {
    return(list(seasonal_growth = seas_gr, year_growth = year_gr))
  }
  
  if (freq == 12) {
    return(list(seasonal_growth = seas_gr, year_growth = year_gr,
                quarter_growth = quarter_gr))
  }
  
  

}

print_growths <- function(seas_and_yr_gr) {
  seas_gr <- seas_and_yr_gr[["seasonal_growth"]]
  year_gr <- seas_and_yr_gr[["year_growth"]]
  quarter_gr <- seas_and_yr_gr[["quarter_growth"]]

  seas <- knitr::kable(tail(as_tibble(seas_gr) %>% select(-value), n = 8), 
             digits = 1, align = 'lcc')

  yr <- knitr::kable(tail(as_tibble(year_gr) %>% select(-y_rgdp), n = 5),
               digits = 1, align = 'lccc')  
  
  if (is.null(quarter_gr)) {
    
    walk(list(seas, yr), print)
    
  } else {
    
    qtr <- knitr::kable(tail(as_tibble(quarter_gr) %>% select(-q_rgdp), n = 5),
               digits = 1, align = 'lccc') 
    
    walk(list(seas, yr, qtr), print)
    
  }
  
}

```



## Initial data


```{r preferences_and_load_data, warning=FALSE}
arima_res_suffix <- "_min"
arima_rds_path = "data/sarimax_objects_"
country_name <- "Bolivia_activ"
# data_path <- "./data/excel/Chile.xlsx"
data_path <- paste0("./data/excel/", country_name, ".xlsx")
external_data_path <- "./data/external/external_us.xlsx"
is_log_log <- TRUE

all_arima_data <- ts_data_for_arima(data_path = data_path, 
                                    external_data_path = external_data_path,
                                    all_logs = is_log_log)

this_rgdp_ts <- all_arima_data[["rgdp_ts"]]
this_rgdp_ts <- na.omit(this_rgdp_ts)

this_internal_monthly_ts <- all_arima_data[["monthly_ts"]]
this_external_monthly_ts <- all_arima_data[["external_monthly_ts"]]

internal_monthly_names <- colnames(this_internal_monthly_ts)
external_monthly_names <- colnames(this_external_monthly_ts)

```

Log transformation applied to all variables. Data obtained from the excel file `r print(data_path)` 

### Quarterly real GDP


```{r plot_level_rgdp}
autoplot(this_rgdp_ts) + 
  ggtitle(paste("Quarterly GDP")) 

```


```{r plot_yoy_gr_rgdp}

autoplot(make_yoy_ts(this_rgdp_ts, is_log = TRUE)) + 
  ggtitle(paste("YoY growth, Quarterly GDP")) 
```


```{r plot_level_e_i}
autoplot(this_internal_monthly_ts, series = "internal") + 
  autolayer(this_external_monthly_ts, series = "external")

ei_level_ts  <- ts.union(int = na.omit(this_internal_monthly_ts), 
                         ext = na.omit(this_external_monthly_ts))

tail_level <- tail(ei_level_ts, n = 12)

tail_level 
```

```{r plot_yoy_growth_e_i}
autoplot(make_yoy_ts(this_internal_monthly_ts, freq = 12, is_log = TRUE),
         series = "internal") + 
  autolayer(make_yoy_ts(this_external_monthly_ts, freq = 12, is_log = TRUE),
            series = "external") 


ei_yoy_gr_ts  <- ts.union(int = na.omit(
  make_yoy_ts(this_internal_monthly_ts, freq = 12, is_log = TRUE)), 
                         ext = na.omit(
  make_yoy_ts(this_external_monthly_ts, freq = 12, is_log = TRUE))
                           )

tail_yoy <- 100*tail(ei_yoy_gr_ts, n = 14)


  
tail_yoy

```


Data availability notes:

- Our key data, real GDP is available up to 2017 Q3
- The internal variable (monthly activity index) is available only up to May 2017. This is, partially covers 2017 Q2 but none of 2017 Q3.
- The external variable (monthly US activity index) is available up to February 2018, partially covering 2018 Q1.



### Quarterly versions of GDP and monthly data 

In terms of growth rates
```{r gr_data}

gr_q_y_rgdp <- seas_yr_growth(na.omit(this_rgdp_ts))
gr_m_y_q_internal <- seas_yr_growth(na.omit(this_internal_monthly_ts), 
                                    freq = 12)
gr_m_y_q_external <- seas_yr_growth(na.omit(this_external_monthly_ts),
                                    freq = 12)

q_r_growth <- gr_q_y_rgdp$seasonal_growth %>% 
  rename(quarter_index = index, rgdp_growth = gr) %>%
  select(quarter_index, rgdp_growth)
  
q_e_growth <- gr_m_y_q_internal$quarter_growth %>% 
  rename(dom_growth = q_ave_gr) %>% 
  select(quarter_index, dom_growth)

q_i_growth <- gr_m_y_q_external$quarter_growth %>% 
  rename(ext_growth = q_ave_gr) %>% 
  select(quarter_index, ext_growth)

q_rie_growth <- left_join(q_r_growth, q_i_growth, by = "quarter_index") %>% 
  left_join(q_e_growth, by = "quarter_index")


knitr::kable(tail(q_rie_growth, n = 8), digits = 1)


# print_growths(gr_q_y)
# walk(gr_q_y, ~ print(tail(.)))
# walk(gr_m_y_q_internal, ~ print(tail(.)))
# walk(gr_m_y_q_external, ~ print(tail(.)))


```



## Initial GDP specification and forecast


```{r rgpd_uncond_arimas_dm_force}
final_forecast_horizon <- c(2019, 12)
h_max <-  8 # last rgdp data is 2017 Q4
test_length <- h_max
number_of_cv = 8
train_span = 16
use_demetra <- TRUE

use_dm_force_constant <- TRUE

lambda_0_in_auto <- FALSE
mean_logical_in_auto <- TRUE
max_x_lag <- 2


if (use_demetra) {
  do_auto <- FALSE
  demetra_output <- get_demetra_params(data_path)
  demetra_output_external <- get_demetra_params(external_data_path)
  
  rgdp_order_list <- demetra_output[["rgdp_order_list"]][[1]]
  rgdp_order_list_dm_s <- rgdp_order_list
  rgdp_order_list_dm_r <- rgdp_order_list
  
  
  
  fit_arima_rgdp_list_dem <- fit_arimas(
    y_ts = this_rgdp_ts, order_list = demetra_output[["rgdp_order_list"]],
    this_arima_names = "rgdp", force_constant = use_dm_force_constant, print_comments_on_constant = TRUE)
  
  this_rgdp_arima <- fit_arima_rgdp_list_dem
  
  monthly_with_demetra_info <- names(demetra_output[["monthly_order_list"]])
  log_vec <- internal_monthly_names %in% monthly_with_demetra_info
  if (any(!log_vec)) {
    print("At least one of the variables in monthly does not have a DEMETRA line and will not be considered.")
    print("These variables are:")
    print(internal_monthly_names[!log_vec])
    internal_monthly_names <- internal_monthly_names[log_vec]
    this_internal_monthly_ts <- this_internal_monthly_ts[, internal_monthly_names]
  }
  
  
  if (use_dm_force_constant) {
    this_non_external <- "non_external_dm_s" 
    this_external <- "external_dm_s" 
    do_dm_strict <-  FALSE
    
    t_for_fit <- seq(1, length(this_rgdp_arima[["rgdp"]]$x))
    t_for_fit_sq <- t_for_fit^2
    
    t_for_fc <- seq(length(this_rgdp_arima[["rgdp"]]$x)+1,
                    length(this_rgdp_arima[["rgdp"]]$x)+h_max)
    t_for_fc_sq <- t_for_fc^2
    
    rgdp_uncond_fc <- forecast(this_rgdp_arima[["rgdp"]], 
                               h = h_max, xreg = t_for_fc_sq)
    rgdp_uncond_fc_mean <- rgdp_uncond_fc$mean
    
    print(rgdp_uncond_fc_mean)
    
    rgdp_and_uncond_fc_dm_f <- ts(data = c(rgdp_uncond_fc$x, 
                                  rgdp_uncond_fc$mean), 
                         frequency = 4,
                         start = start(this_rgdp_ts))

    gr_q_y_rgdp_and_unc_fc_dm_f <- seas_yr_growth(na.omit(rgdp_and_uncond_fc_dm_f))

    q_rfc_growth_dm_f <- gr_q_y_rgdp_and_unc_fc_dm_f$seasonal_growth %>% 
    rename(quarter_index = index, rgdp_growth_dm_f = gr) %>%
    select(quarter_index, rgdp_growth_dm_f)
    
    
  } else {
    this_non_external <- "non_external_dm_r" 
    this_external <- "external_dm_r" 
    do_dm_strict <-  TRUE
  }
} else {
  do_auto <- TRUE
  fit_arima_rgdp_list_auto <- fit_arimas(y_ts = this_rgdp_ts, auto = TRUE,  
                                         this_arima_names = "rgdp", 
                                         my_lambda = NULL,
                                         do_approximation = TRUE)
  this_rgdp_arima <- fit_arima_rgdp_list_auto
  
  gdp_order <- get_order_from_arima(this_rgdp_arima)[[1]]
  rgdp_order <-  gdp_order[c("p", "d", "q")]
  rgdp_seasonal <-  gdp_order[c("P", "D", "Q")]
  
  rgdp_order_list <- list(order = rgdp_order, seasonal = rgdp_seasonal,
                          mean_logical = mean_logical_in_auto,
                          log_logical = lambda_0_in_auto)
  
  rgdp_order_list_auto <- rgdp_order_list
  
  do_dm_strict <-  TRUE
  this_non_external <- "non_external_auto_r" 
  this_external <- "external_auto_r"
  demetra_output <- NULL
  demetra_output_external <- NULL
}



this_rgdp_arima_dm_s <- this_rgdp_arima


print(this_rgdp_arima[["rgdp"]])

# pander::pander(this_rgdp_arima[["rgdp"]])
# 
# autoplot(rgdp_uncond_fc)
# 
# knitr::kable(tail(q_rfc_growth_dm_f, n = 11), digits = 1)


```



```{r rgpd_uncond_arimas_dm_not_force}
final_forecast_horizon <- c(2019, 12)
h_max <-  8 # last rgdp data is 2017 Q4
test_length <- h_max
number_of_cv = 8
train_span = 16
use_demetra <- TRUE

use_dm_force_constant <- FALSE

lambda_0_in_auto <- FALSE
mean_logical_in_auto <- TRUE
max_x_lag <- 2


if (use_demetra) {
  do_auto <- FALSE
  demetra_output <- get_demetra_params(data_path)
  demetra_output_external <- get_demetra_params(external_data_path)
  
  rgdp_order_list <- demetra_output[["rgdp_order_list"]][[1]]
  
  fit_arima_rgdp_list_dem <- fit_arimas(
    y_ts = this_rgdp_ts, order_list = demetra_output[["rgdp_order_list"]],
    this_arima_names = "rgdp")
  
  this_rgdp_arima <- fit_arima_rgdp_list_dem
  
  monthly_with_demetra_info <- names(demetra_output[["monthly_order_list"]])
  log_vec <- internal_monthly_names %in% monthly_with_demetra_info
  if (any(!log_vec)) {
    print("At least one of the variables in monthly does not have a DEMETRA line and will not be considered.")
    print("These variables are:")
    print(internal_monthly_names[!log_vec])
    internal_monthly_names <- internal_monthly_names[log_vec]
    this_internal_monthly_ts <- this_internal_monthly_ts[, internal_monthly_names]
  }
  
  
  if (use_dm_force_constant) {
    this_non_external <- "non_external_dm_s" 
    this_external <- "external_dm_s" 
    do_dm_strict <-  FALSE
    
  } else {
    this_non_external <- "non_external_dm_r" 
    this_external <- "external_dm_r" 
    do_dm_strict <-  TRUE
  }
} else {
  do_auto <- TRUE
  fit_arima_rgdp_list_auto <- fit_arimas(y_ts = this_rgdp_ts, auto = TRUE,  
                                         this_arima_names = "rgdp", 
                                         my_lambda = NULL,
                                         do_approximation = TRUE)
  this_rgdp_arima <- fit_arima_rgdp_list_auto
  
  gdp_order <- get_order_from_arima(this_rgdp_arima)[[1]]
  rgdp_order <-  gdp_order[c("p", "d", "q")]
  rgdp_seasonal <-  gdp_order[c("P", "D", "Q")]
  
  rgdp_order_list <- list(order = rgdp_order, seasonal = rgdp_seasonal,
                          mean_logical = mean_logical_in_auto,
                          log_logical = lambda_0_in_auto)
  
  do_dm_strict <-  TRUE
  this_non_external <- "non_external_auto_r" 
  this_external <- "external_auto_r"
  demetra_output <- NULL
  demetra_output_external <- NULL
}


rgdp_uncond_fc <- forecast(this_rgdp_arima[["rgdp"]], h = h_max)
rgdp_uncond_fc_mean <- rgdp_uncond_fc$mean

rgdp_and_uncond_fc_dm_nf <- ts(data = c(rgdp_uncond_fc$x, 
                                  rgdp_uncond_fc$mean), 
                         frequency = 4,
                         start = start(this_rgdp_ts))

gr_q_y_rgdp_and_unc_fc_dm_nf <- seas_yr_growth(na.omit(rgdp_and_uncond_fc_dm_nf))

q_rfc_growth_dm_nf <- gr_q_y_rgdp_and_unc_fc_dm_nf$seasonal_growth %>% 
  rename(quarter_index = index, rgdp_growth_dm_nf = gr) %>%
  select(quarter_index, rgdp_growth_dm_nf)

print(this_rgdp_arima[["rgdp"]])

this_rgdp_arima_dm_r <- this_rgdp_arima

# pander::pander(this_rgdp_arima[["rgdp"]])

# autoplot(rgdp_uncond_fc)
# 
# knitr::kable(tail(q_rfc_growth, n = 11), digits = 1)


```



```{r rgpd_uncond_arimas_auto}
final_forecast_horizon <- c(2019, 12)
h_max <-  8 # last rgdp data is 2017 Q4
test_length <- h_max
number_of_cv = 8
train_span = 16
use_demetra <- FALSE

use_dm_force_constant <- TRUE

lambda_0_in_auto <- FALSE
mean_logical_in_auto <- TRUE
max_x_lag <- 2


if (use_demetra) {
  do_auto <- FALSE
  demetra_output <- get_demetra_params(data_path)
  demetra_output_external <- get_demetra_params(external_data_path)
  
  rgdp_order_list <- demetra_output[["rgdp_order_list"]][[1]]
  
  fit_arima_rgdp_list_dem <- fit_arimas(
    y_ts = this_rgdp_ts, order_list = demetra_output[["rgdp_order_list"]],
    this_arima_names = "rgdp", print_comments_on_constant = TRUE)
  
  this_rgdp_arima <- fit_arima_rgdp_list_dem
  
  monthly_with_demetra_info <- names(demetra_output[["monthly_order_list"]])
  log_vec <- internal_monthly_names %in% monthly_with_demetra_info
  if (any(!log_vec)) {
    print("At least one of the variables in monthly does not have a DEMETRA line and will not be considered.")
    print("These variables are:")
    print(internal_monthly_names[!log_vec])
    internal_monthly_names <- internal_monthly_names[log_vec]
    this_internal_monthly_ts <- this_internal_monthly_ts[, internal_monthly_names]
  }
  
  
  if (use_dm_force_constant) {
    this_non_external <- "non_external_dm_s" 
    this_external <- "external_dm_s" 
    do_dm_strict <-  FALSE
  } else {
    this_non_external <- "non_external_dm_r" 
    this_external <- "external_dm_r" 
    do_dm_strict <-  TRUE
  }
} else {
  do_auto <- TRUE
  fit_arima_rgdp_list_auto <- fit_arimas(y_ts = this_rgdp_ts, auto = TRUE,  
                                         this_arima_names = "rgdp", 
                                         my_lambda = NULL,
                                         do_stepwise = FALSE,
                                         do_approximation = FALSE,
                                         print_comments_on_constant = TRUE)
  this_rgdp_arima <- fit_arima_rgdp_list_auto
  
  gdp_order <- get_order_from_arima(this_rgdp_arima)[[1]]
  rgdp_order <-  gdp_order[c("p", "d", "q")]
  rgdp_seasonal <-  gdp_order[c("P", "D", "Q")]
  
  rgdp_order_list <- list(order = rgdp_order, seasonal = rgdp_seasonal,
                          mean_logical = mean_logical_in_auto,
                          log_logical = lambda_0_in_auto)
  
  rgdp_order_list_auto <- rgdp_order_list
  
  do_dm_strict <-  TRUE
  this_non_external <- "non_external_auto_r" 
  this_external <- "external_auto_r"
  demetra_output <- NULL
  demetra_output_external <- NULL
}


rgdp_uncond_fc <- forecast(this_rgdp_arima[["rgdp"]], h = h_max)
rgdp_uncond_fc_mean <- rgdp_uncond_fc$mean

rgdp_and_uncond_fc_auto <- ts(data = c(rgdp_uncond_fc$x, 
                                  rgdp_uncond_fc$mean), 
                         frequency = 4,
                         start = start(this_rgdp_ts))

gr_q_y_rgdp_and_unc_fc_auto <- seas_yr_growth(na.omit(rgdp_and_uncond_fc_auto))

q_rfc_growth_auto <- gr_q_y_rgdp_and_unc_fc_auto$seasonal_growth %>% 
  rename(quarter_index = index, rgdp_growth_auto = gr) %>%
  select(quarter_index, rgdp_growth_auto)

print(this_rgdp_arima[["rgdp"]])


this_rgdp_arima_auto <- this_rgdp_arima

# pander::pander(this_rgdp_arima[["rgdp"]])

# autoplot(rgdp_uncond_fc)
# 
# knitr::kable(tail(q_rfc_growth, n = 11), digits = 1)


```

```{r all_3_uncond_arimas}

yoy3 <- 100 * make_yoy_ts(ts.union(rgdp_and_uncond_fc_auto, 
                             rgdp_and_uncond_fc_dm_nf, 
                             rgdp_and_uncond_fc_dm_f), is_log = TRUE)

rgdp_ext_gr_auto <- seas_yr_growth(rgdp_and_uncond_fc_auto)
rgdp_ext_gr_dm_f <- seas_yr_growth(rgdp_and_uncond_fc_dm_f)
rgdp_ext_gr_dm_nf <- seas_yr_growth(rgdp_and_uncond_fc_dm_nf)

re_gr_auto <- rgdp_ext_gr_auto$seasonal_growth %>% select(index, gr) %>% 
  rename(auto_gr = gr)
re_gr_dm_nf <- rgdp_ext_gr_dm_nf$seasonal_growth %>% select(index, gr) %>% 
  rename(dm_nf_gr = gr)
re_gr_dm_f <- rgdp_ext_gr_dm_f$seasonal_growth %>% select(index, gr) %>% 
  rename(dm_f_gr = gr)

knitr::kable(tail(left_join(re_gr_auto, re_gr_dm_nf, by = "index") %>% 
       left_join(re_gr_dm_f, by = "index"), n = 12), digits = 2)



```



## Forecasting and extending monthly data


```{r extending_monthly_dm_s}

tic()
use_demetra <- TRUE
use_dm_force_constant <- TRUE
do_dm_strict <- FALSE
demetra_output <- get_demetra_params(data_path)
demetra_output_external <- get_demetra_params(external_data_path)
this_non_external <- "non_external_dm_s" 
this_external <- "external_dm_s" 


extended_data_dm_s <- get_extended_monthly_variables(
  do_auto = do_auto,
  use_demetra = use_demetra,
  do_dm_strict = do_dm_strict,
  do_dm_force_constant = use_dm_force_constant,
  monthly_data_ts = this_internal_monthly_ts,
  monthly_data_external_ts = this_external_monthly_ts,
  order_list = demetra_output,
  order_list_external = demetra_output_external,
  data_path = data_path,
  final_forecast_horizon = final_forecast_horizon,
  print_comments_on_constant = TRUE)
toc()

internal_mdata_ext_ts_dm_s <- extended_data_dm_s[[this_non_external]][["quarterly_series_ts"]]
external_mdata_ext_ts_dm_s <- extended_data_dm_s[[this_external]][["quarterly_series_ts"]]

m_internal_mdata_ext_ts_dm_s <- extended_data_dm_s[[this_non_external]][["monthly_series_ts"]]
m_external_mdata_ext_ts_dm_s <- extended_data_dm_s[[this_external]][["monthly_series_ts"]]

mdata_ext_ts_dm_s <- ts.union(internal_mdata_ext_ts_dm_s, external_mdata_ext_ts_dm_s)
monthly_names <- c(internal_monthly_names, external_monthly_names)
colnames(mdata_ext_ts_dm_s) <- monthly_names
```

```{r manual_ext_monthly_dm_s}
print(demetra_output$monthly_order_list)
print(demetra_output_external$monthly_order_list)

dm_internal_order <- c(2, 1, 1)
dm_internal_seasonal <- c(0, 1, 1)

dm_external_order <- c(0, 1, 2)
dm_external_seasonal <- c(0, 0, 0)

nao_external_ts <- na.omit(this_external_monthly_ts)
nao_internal_ts <- na.omit(this_internal_monthly_ts)

n_internal <- length(nao_internal_ts)
t_internal <- seq(1, n_internal)
t_internal_sq <- t_internal^2

internal_arima_manual_dm_s <- Arima(y = nao_internal_ts, xreg = t_internal_sq, order = dm_internal_order, seasonal = dm_internal_seasonal, method = "CSS")

t_internal_fc <- seq(n_internal+1, n_internal+31)
t_internal_fc_sq <- t_internal_fc^2

internal_fc_manual_dm_s <- forecast(internal_arima_manual_dm_s, h = 31, xreg = t_internal_fc_sq)
internal_fc_manual_dm_s_mean <- internal_fc_manual_dm_s$mean
manual_ext_int_dm_s <- ts(data=c(nao_internal_ts, internal_fc_manual_dm_s_mean),
                          start = start(nao_internal_ts), frequency = 12)

internal_arima_manual_dm_s_ml <- Arima(y = nao_internal_ts, xreg = t_internal_sq, order = dm_internal_order, seasonal = dm_internal_seasonal, method = "ML")
internal_fc_manual_dm_s_ml <- forecast(internal_arima_manual_dm_s_ml, h = 31, xreg = t_internal_fc_sq)
internal_fc_manual_dm_s_mean_ml <- internal_fc_manual_dm_s_ml$mean
manual_ext_int_dm_s_ml <- ts(data=c(nao_internal_ts, internal_fc_manual_dm_s_mean_ml),
                          start = start(nao_internal_ts), frequency = 12)

# print(manual_ext_int_dm_s)
# print(m_internal_mdata_ext_ts_dm_s)

idms3 <- ts.union(m_internal_mdata_ext_ts_dm_s, manual_ext_int_dm_s, 
               manual_ext_int_dm_s_ml)

idms3_yoy <- 100 * make_yoy_ts(ts.union(m_internal_mdata_ext_ts_dm_s, manual_ext_int_dm_s, 
               manual_ext_int_dm_s_ml), freq = 12, is_log = TRUE)
colnames(idms3_yoy) <- c("myfun", "css", "ml")

# print(idms3)
# print(idms3_yoy)
ei_dm_s_gr <- seas_yr_growth(manual_ext_int_dm_s_ml, freq = 12) 
q_dm_s_gr <- ei_dm_s_gr$quarter_growth %>% 
  rename(gr_dm_s = q_ave_gr) %>% select(quarter_index, gr_dm_s)

```




```{r extending_monthly_dm_r}

tic()
use_demetra <- TRUE
use_dm_force_constant <- FALSE
do_dm_strict <- TRUE
demetra_output <- get_demetra_params(data_path)
demetra_output_external <- get_demetra_params(external_data_path)
this_non_external <- "non_external_dm_r" 
this_external <- "external_dm_r" 

extended_data_dm_r <- get_extended_monthly_variables(
  do_auto = do_auto,
  use_demetra = use_demetra,
  do_dm_strict = do_dm_strict,
  do_dm_force_constant = use_dm_force_constant,
  monthly_data_ts = this_internal_monthly_ts,
  monthly_data_external_ts = this_external_monthly_ts,
  order_list = demetra_output,
  order_list_external = demetra_output_external,
  data_path = data_path,
  final_forecast_horizon = final_forecast_horizon,
  print_comments_on_constant = TRUE)
toc()

internal_mdata_ext_ts_dm_r <- extended_data_dm_r[[this_non_external]][["quarterly_series_ts"]]
external_mdata_ext_ts_dm_r <- extended_data_dm_r[[this_external]][["quarterly_series_ts"]]

m_internal_mdata_ext_ts_dm_r <- extended_data_dm_r[[this_non_external]][["monthly_series_ts"]]
m_external_mdata_ext_ts_dm_r <- extended_data_dm_r[[this_external]][["monthly_series_ts"]]

mdata_ext_ts_dm_r <- ts.union(internal_mdata_ext_ts_dm_r, external_mdata_ext_ts_dm_r)
monthly_names <- c(internal_monthly_names, external_monthly_names)
colnames(mdata_ext_ts_dm_r) <- monthly_names
```


```{r manual_ext_monthly_dm_r}

internal_arima_manual_dm_r <- Arima(y = nao_internal_ts, order = dm_internal_order, seasonal = dm_internal_seasonal)
internal_fc_manual_dm_r <- forecast(internal_arima_manual_dm_r, h = 31)
internal_fc_manual_dm_r_mean <- internal_fc_manual_dm_r$mean
manual_ext_int_dm_r <- ts(data = c(nao_internal_ts, internal_fc_manual_dm_r_mean),
                          start = start(nao_internal_ts), frequency = 12)

idmr <- ts.union(m_internal_mdata_ext_ts_dm_r, manual_ext_int_dm_r) 
colnames(idmr) <- c("myfun", "manual")
# print(idmr)

ei_dm_r_gr <- seas_yr_growth(manual_ext_int_dm_r, freq = 12)
q_dm_r_gr <- ei_dm_r_gr$quarter_growth %>% 
  rename(gr_dm_r = q_ave_gr) %>% select(quarter_index, gr_dm_r)

external_arima_manual_dm_r <- Arima(y = nao_external_ts, order = dm_external_order, 
                                    seasonal = dm_external_seasonal,
                                    include.constant = TRUE)

external_fc_manual_dm_r <- forecast(external_arima_manual_dm_r, h = 22)
external_fc_manual_dm_r_mean <- external_fc_manual_dm_r$mean
manual_ext_ext_dm_r <- ts(data = c(nao_external_ts, external_fc_manual_dm_r_mean),
                          start = start(nao_external_ts), frequency = 12)

edmr <- ts.union(m_external_mdata_ext_ts_dm_r, manual_ext_ext_dm_r) 
colnames(edmr) <- c("myfun", "manual")
# print(tail(edmr))

ee_dm_r_gr <- seas_yr_growth(manual_ext_ext_dm_r, freq = 12)
eq_dm_r_gr <- ee_dm_r_gr$quarter_growth %>% 
  rename(gr_dm_r = q_ave_gr) %>% select(quarter_index, gr_dm_r)



yoy_manual_ex_dm_r <- 100 * make_yoy_ts(manual_ext_ext_dm_r, freq = 12, is_log = TRUE)
yoy_myfun_ex_dm_r <- 100 * make_yoy_ts(m_external_mdata_ext_ts_dm_r, freq = 12, is_log = TRUE)

# tail(ts.union(yoy_manual_ex_dm_r, yoy_myfun_ex_dm_r), n = 24)

```



```{r extending_monthly_auto}

tic()
use_demetra <- FALSE
do_auto <- TRUE
use_dm_force_constant <- FALSE
do_dm_strict <- TRUE
this_non_external <- "non_external_auto_r" 
this_external <- "external_auto_r"

extended_data_auto <- get_extended_monthly_variables(
  do_auto = do_auto,
  use_demetra = use_demetra,
  do_dm_strict = do_dm_strict,
  do_dm_force_constant = use_dm_force_constant,
  monthly_data_ts = this_internal_monthly_ts,
  monthly_data_external_ts = this_external_monthly_ts,
  order_list = demetra_output,
  order_list_external = demetra_output_external,
  data_path = data_path,
  final_forecast_horizon = final_forecast_horizon)
toc()

internal_mdata_ext_ts_auto <- extended_data_auto[[this_non_external]][["quarterly_series_ts"]]
external_mdata_ext_ts_auto <- extended_data_auto[[this_external]][["quarterly_series_ts"]]

m_internal_mdata_ext_ts_auto <- extended_data_auto[[this_non_external]][["monthly_series_ts"]]
m_external_mdata_ext_ts_auto <- extended_data_auto[[this_external]][["monthly_series_ts"]]

mdata_ext_ts_auto <- ts.union(internal_mdata_ext_ts_auto, external_mdata_ext_ts_auto)
monthly_names <- c(internal_monthly_names, external_monthly_names)
colnames(mdata_ext_ts_auto) <- monthly_names
```


```{r manual_ext_monthly_auto}

internal_arima_manual_auto <- auto.arima(y = nao_internal_ts)
internal_arima_manual_auto
internal_fc_manual_auto <- forecast(internal_arima_manual_auto, h = 31)
internal_fc_manual_auto_mean <- internal_fc_manual_auto$mean
manual_ext_int_auto <- ts(data = c(nao_internal_ts, internal_fc_manual_auto_mean),
                          start = start(nao_internal_ts), frequency = 12)

idma <- ts.union(m_internal_mdata_ext_ts_auto, manual_ext_int_auto) 
colnames(idma) <- c("myfun", "manual")
print(idma)

ei_auto_gr <- seas_yr_growth(manual_ext_int_auto, freq = 12) 
q_auto_gr <- ei_auto_gr$quarter_growth %>% 
  rename(gr_auto = q_ave_gr) %>% select(quarter_index, gr_auto)


external_arima_manual_auto_slow <- auto.arima(y = nao_external_ts, stepwise = FALSE, approximation = FALSE)
external_arima_manual_auto_slow


external_arima_manual_auto_slow <- auto.arima(y = nao_external_ts, stepwise = FALSE, approximation = FALSE, max.d = 1)
external_arima_manual_auto_slow

# external_arima_manual_auto_slow_P0 <- auto.arima(y = nao_external_ts, stepwise = FALSE, approximation = FALSE, max.P = 0, start.P = 0, max.Q = 0, start.Q = 0)
# external_arima_manual_auto_slow_P0

external_arima_manual_auto <- auto.arima(y = nao_external_ts)
external_arima_manual_auto

external_fc_manual_auto <- forecast(external_arima_manual_auto, h = 22)
external_fc_manual_auto_mean <- external_fc_manual_auto$mean
manual_ext_ext_auto <- ts(data = c(nao_external_ts, external_fc_manual_auto_mean),
                          start = start(nao_external_ts), frequency = 12)

external_fc_manual_auto_slow <- forecast(external_arima_manual_auto_slow, h = 22)
external_fc_manual_auto_mean_slow <- external_fc_manual_auto_slow$mean
manual_ext_ext_auto_slow <- ts(data = c(nao_external_ts, external_fc_manual_auto_mean_slow),
                          start = start(nao_external_ts), frequency = 12)

edma <- ts.union(m_external_mdata_ext_ts_auto, 
                 manual_ext_ext_auto_slow, manual_ext_ext_dm_r) 
colnames(edma) <- c("myfun",  "manual_slow", "manual_dm_r")
# print(tail(edma))

edma_yoy <- 100 * make_yoy_ts(edma, freq = 12, is_log = TRUE)
colnames(edma_yoy) <- c("myfun", "manual_slow", "manual_dm_r")
# print(edma_yoy)


# autoplot(edma, facets = FALSE) +  coord_cartesian(xlim = c(2010, 2020))
# autoplot(edma_yoy, facets = FALSE) +  coord_cartesian(xlim = c(2010, 2020))


```


```{r growth_of_extended_variables}

# monthly
imgr_auto <- seas_yr_growth(m_internal_mdata_ext_ts_auto, freq = 12)
emgr_auto <- seas_yr_growth(m_external_mdata_ext_ts_auto, freq = 12)
imgr_dm_r <- seas_yr_growth(m_internal_mdata_ext_ts_dm_r, freq = 12)
emgr_dm_r <- seas_yr_growth(m_external_mdata_ext_ts_dm_r, freq = 12)
imgr_dm_s <- seas_yr_growth(m_internal_mdata_ext_ts_dm_s, freq = 12)
emgr_dm_s <- seas_yr_growth(m_external_mdata_ext_ts_dm_s, freq = 12)

# quarterly
iqgr_auto <- seas_yr_growth(internal_mdata_ext_ts_auto, freq = 4)
eqgr_auto <- seas_yr_growth(external_mdata_ext_ts_auto, freq = 4)
iqgr_dm_r <- seas_yr_growth(internal_mdata_ext_ts_dm_r, freq = 4)
eqgr_dm_r <- seas_yr_growth(external_mdata_ext_ts_dm_r, freq = 4)
iqgr_dm_s <- seas_yr_growth(internal_mdata_ext_ts_dm_s, freq = 4)
eqgr_dm_s <- seas_yr_growth(external_mdata_ext_ts_dm_s, freq = 4)


im_gr <- left_join(
  imgr_auto$seasonal_growth %>% select(index, gr) %>% rename(m_auto = gr),
  imgr_dm_r$seasonal_growth %>% select(index, gr) %>% rename(m_dm_r = gr),
  by = "index") %>% left_join(
    imgr_dm_s$seasonal_growth %>% select(index, gr) %>% rename(m_dm_s = gr),
    by = "index")

em_gr <- left_join(
  emgr_auto$seasonal_growth %>% select(index, gr) %>% rename(m_auto = gr),
  emgr_dm_r$seasonal_growth %>% select(index, gr) %>% rename(m_dm_r = gr),
  by = "index") %>% left_join(
    emgr_dm_s$seasonal_growth %>% select(index, gr) %>% rename(m_dm_s = gr),
    by = "index")

iq_gr <- left_join(
  iqgr_auto$seasonal_growth %>% select(index, gr) %>% rename(q_auto = gr),
  iqgr_dm_r$seasonal_growth %>% select(index, gr) %>% rename(q_dm_r = gr),
  by = "index") %>% left_join(
    iqgr_dm_s$seasonal_growth %>% select(index, gr) %>% rename(q_dm_s = gr),
    by = "index")

eq_gr <- left_join(
  eqgr_auto$seasonal_growth %>% select(index, gr) %>% rename(q_auto = gr),
  eqgr_dm_r$seasonal_growth %>% select(index, gr) %>% rename(q_dm_r = gr),
  by = "index") %>% left_join(
    eqgr_dm_s$seasonal_growth %>% select(index, gr) %>% rename(q_dm_s = gr),
    by = "index")

imq_gr <- left_join(
  imgr_auto$quarter_growth %>% select(quarter_index, q_ave_gr) %>% rename(mq_auto = q_ave_gr),
  imgr_dm_r$quarter_growth %>% select(quarter_index, q_ave_gr) %>% rename(mq_dm_r = q_ave_gr),
  by = "quarter_index") %>% left_join(
    imgr_dm_s$quarter_growth %>% select(quarter_index, q_ave_gr) %>% rename(mq_dm_s = q_ave_gr),
    by = "quarter_index")

emq_gr <- left_join(
  emgr_auto$quarter_growth %>% select(quarter_index, q_ave_gr) %>% rename(mq_auto = q_ave_gr),
  emgr_dm_r$quarter_growth %>% select(quarter_index, q_ave_gr) %>% rename(mq_dm_r = q_ave_gr),
  by = "quarter_index") %>% left_join(
    emgr_dm_s$quarter_growth %>% select(quarter_index, q_ave_gr) %>% rename(mq_dm_s = q_ave_gr),
    by = "quarter_index")

iy_gr <- left_join(
  iqgr_auto$year_growth %>% select(year_index, y_ave_gr) %>% rename(y_auto = y_ave_gr),
  iqgr_dm_r$year_growth %>% select(year_index, y_ave_gr) %>% rename(y_dm_r = y_ave_gr),
  by = "year_index") %>% left_join(
    iqgr_dm_s$year_growth %>% select(year_index, y_ave_gr) %>% rename(y_dm_s = y_ave_gr),
    by = "year_index")

ey_gr <- left_join(
  eqgr_auto$year_growth %>% select(year_index, y_ave_gr) %>% rename(y_auto = y_ave_gr),
  eqgr_dm_r$year_growth %>% select(year_index, y_ave_gr) %>% rename(y_dm_r = y_ave_gr),
  by = "year_index") %>% left_join(
    eqgr_dm_s$year_growth %>% select(year_index, y_ave_gr) %>% rename(y_dm_s = y_ave_gr),
    by = "year_index")


tail(im_gr, n = 24)
tail(iq_gr, n = 8)
tail(imq_gr, n = 8)
tail(iy_gr)


tail(em_gr, n = 24)
tail(eq_gr, n = 8)
tail(emq_gr, n = 8)
tail(ey_gr)



```



```{r temp}

ext_int3  <- ts.union(manual_ext_int_dm_s_ml, manual_ext_int_dm_r, 
                      manual_ext_int_auto)
ext_int3_yoy <- 100 * make_yoy_ts(ext_int3, freq = 12, is_log = TRUE)
colnames(ext_int3_yoy) <- c("dm_s", "dm_r", "auto")
# ext_int3_yoy

# autoplot(ext_int3, facets = FALSE) + coord_cartesian(xlim = c(2012,2020)) 
# autoplot(ext_int3_yoy, facets = FALSE) + coord_cartesian(xlim = c(2012,2020))


ext_ext3  <- ts.union(manual_ext_ext_dm_r, 
                      manual_ext_int_auto)
ext_ext3_yoy <- 100 * make_yoy_ts(ext_ext3, freq = 12, is_log = TRUE)
colnames(ext_ext3_yoy) <- c("dm_r", "auto")
# ext_ext3_yoy
# 
# autoplot(ext_int3, facets = FALSE) + coord_cartesian(xlim = c(2012,2020)) 
# autoplot(ext_int3_yoy, facets = FALSE) + coord_cartesian(xlim = c(2012,2020))

ei_dm_s_gr <- seas_yr_growth(manual_ext_int_dm_s_ml, freq = 12) 
ei_dm_r_gr <- seas_yr_growth(manual_ext_int_dm_r, freq = 12) 
ei_auto_gr <- seas_yr_growth(manual_ext_int_auto, freq = 12) 

q_dm_s_gr <- ei_dm_s_gr$quarter_growth %>% 
  rename(gr_dm_s = q_ave_gr) %>% select(quarter_index, gr_dm_s)

q_dm_r_gr <- ei_dm_r_gr$quarter_growth %>% 
  rename(gr_dm_r = q_ave_gr) %>% select(quarter_index, gr_dm_r)

q_auto_gr <- ei_auto_gr$quarter_growth %>% 
  rename(gr_auto = q_ave_gr) %>% select(quarter_index, gr_auto)

q_ars_gr <- left_join(q_auto_gr, q_dm_r_gr, by = "quarter_index") %>% 
  left_join(q_dm_s_gr, by = "quarter_index")

# tail(q_ars_gr, n = 12)

```




### Implied quarterly growth

```{r table_q_y_gr_of_monthly}

tail(iq_gr, n = 8)
tail(iy_gr)


tail(eq_gr, n = 8)
tail(ey_gr)


```




```{r}
ggplot(eq_gr, aes(x = index, y = q_auto)) + 
  geom_line() + 
  geom_line(aes(y = q_dm_r)) + 
  geom_line(aes(y = q_dm_s))  
  
ggplot(ey_gr, aes(x = year_index, y = y_auto)) + 
  geom_line() + 
  geom_line(aes(y = y_dm_r)) + 
  geom_line(aes(y = y_dm_s))  

```

## Conditional forecasting of GDP

```{r full_sample_arimax_dm_s}
# this_rgdp_arima_dm_s
# this_rgdp_arima_dm_r
# this_rgdp_arima_auto

tic()
arimax_and_fcs_dm_s <- get_arimax_and_fcs(y_ts = this_rgdp_ts, 
                          xreg_ts = mdata_ext_ts_dm_s,
                          rgdp_arima = this_rgdp_arima_dm_s,
                          max_x_lag = max_x_lag,
                          rgdp_order_list = rgdp_order_list_dm_s,
                          h_max = h_max,
                          force.constant = TRUE)
toc()

gla_s <- map_dfr(arimax_and_fcs_dm_s$all_arimax$arimax, sw_glance)
gla_s$model.desc <- NULL
gla_s$xvar <- arimax_and_fcs_dm_s$all_arimax$id_fc
gla_s$lag <- arimax_and_fcs_dm_s$all_arimax$lag
gla_s <- gla_s %>%  
  select(c(xvar, lag, logLik, AIC, BIC, RMSE, MAE, MASE, ACF1)) %>% 
  arrange(xvar, AIC)
gla_s 


gla_s <- map_dfr(arimax_and_fcs_dm_s$all_arimax$arimax, sw_glance)
gla_s$model.desc <- NULL
gla_s$xvar <- arimax_and_fcs_dm_s$all_arimax$id_fc
gla_s$lag <- arimax_and_fcs_dm_s$all_arimax$lag
gla_s <- gla_s %>%  
  select(c(xvar, lag, logLik, AIC, BIC, RMSE, MAE, MASE, ACF1)) %>% 
  arrange(xvar, AIC)
gla_s 

swe_s <-  map2(arimax_and_fcs_dm_s$all_arimax$arimax,
               arimax_and_fcs_dm_s$all_arimax$id_fc,
               ~ tidy(.x,  conf.int = TRUE) %>% mutate(id = .y))  %>% 
  reduce(rbind)


swe_s

mfcyoy_s <- reduce(arimax_and_fcs_dm_s$all_fcs$yoy_raw_rgdp_fc, ts.union)
colnames(mfcyoy_s) <- paste("model", 1:ncol(mfcyoy_s), sep = "_")

mrfcyoy_s <- ts.union(make_yoy_ts(rgdp_and_uncond_fc_dm_f, is_log = TRUE), mfcyoy_s)
colnames(mrfcyoy_s) <- c("uncond", colnames(mfcyoy_s))
mrfcyoy_s
autoplot(mrfcyoy_s)


mfc_s <- reduce(arimax_and_fcs_dm_s$all_fcs$raw_rgdp_fc, ts.union)
colnames(mfc_s) <- paste("model", 1:ncol(mfc_s), sep = "_")

mrfc_s <- ts.union(rgdp_and_uncond_fc_dm_f, mfc_s)
colnames(mrfc_s) <- c("uncond", colnames(mfc_s))
mrfc_s
autoplot(mrfc_s)


tsb_mfc_s <- as_tsibble(mfc_s)
tsb_mfc_s



```


```{r full_sample_arimax_dm_r}

tic()
arimax_and_fcs_dm_r <- get_arimax_and_fcs(y_ts = this_rgdp_ts, 
                          xreg_ts = mdata_ext_ts_dm_r,
                          rgdp_arima = this_rgdp_arima_dm_r,
                          max_x_lag = max_x_lag,
                          rgdp_order_list = rgdp_order_list_dm_r,
                          h_max = h_max)
toc()

gla_s <- map_dfr(arimax_and_fcs_dm_r$all_arimax$arimax, sw_glance)
gla_s$model.desc <- NULL
gla_s$xvar <- arimax_and_fcs_dm_r$all_arimax$id_fc
gla_s$lag <- arimax_and_fcs_dm_r$all_arimax$lag
gla_s <- gla_s %>%  
  select(c(xvar, lag, logLik, AIC, BIC, RMSE, MAE, MASE, ACF1)) %>% 
  arrange(xvar, AIC)
gla_s 


gla_s <- map_dfr(arimax_and_fcs_dm_r$all_arimax$arimax, sw_glance)
gla_s$model.desc <- NULL
gla_s$xvar <- arimax_and_fcs_dm_r$all_arimax$id_fc
gla_s$lag <- arimax_and_fcs_dm_r$all_arimax$lag
gla_s <- gla_s %>%  
  select(c(xvar, lag, logLik, AIC, BIC, RMSE, MAE, MASE, ACF1)) %>% 
  arrange(xvar, AIC)
gla_s 

swe_s <-  map2(arimax_and_fcs_dm_r$all_arimax$arimax,
               arimax_and_fcs_dm_r$all_arimax$id_fc,
               ~ tidy(.x,  conf.int = TRUE) %>% mutate(id = .y))  %>% 
  reduce(rbind)


swe_s

mfcyoy_s <- reduce(arimax_and_fcs_dm_r$all_fcs$yoy_raw_rgdp_fc, ts.union)
colnames(mfcyoy_s) <- paste("model", 1:ncol(mfcyoy_s), sep = "_")

mrfcyoy_s <- ts.union(make_yoy_ts(rgdp_and_uncond_fc_dm_nf, is_log = TRUE), mfcyoy_s)
colnames(mrfcyoy_s) <- c("uncond", colnames(mfcyoy_s))
mrfcyoy_s
autoplot(mrfcyoy_s)


mfc_s <- reduce(arimax_and_fcs_dm_s$all_fcs$raw_rgdp_fc, ts.union)
colnames(mfc_s) <- paste("model", 1:ncol(mfc_s), sep = "_")

mrfc_s <- ts.union(rgdp_and_uncond_fc_dm_nf, mfc_s)
colnames(mrfc_s) <- c("uncond", colnames(mfc_s))
mrfc_s
autoplot(mrfc_s)


tsb_mfc_s <- as_tsibble(mfc_s)
tsb_mfc_s



```


```{r full_sample_arimax_auto}
# this_rgdp_arima_dm_s
# this_rgdp_arima_dm_r
# this_rgdp_arima_auto

tic()
arimax_and_fcs_auto <- get_arimax_and_fcs(y_ts = this_rgdp_ts, 
                          xreg_ts = mdata_ext_ts_auto,
                          rgdp_arima = this_rgdp_arima_auto,
                          max_x_lag = max_x_lag,
                          rgdp_order_list = rgdp_order_list_auto,
                          h_max = h_max)
toc()

gla_s <- map_dfr(arimax_and_fcs_auto$all_arimax$arimax, sw_glance)
gla_s$model.desc <- NULL
gla_s$xvar <- arimax_and_fcs_auto$all_arimax$id_fc
gla_s$lag <- arimax_and_fcs_auto$all_arimax$lag
gla_s <- gla_s %>%  
  select(c(xvar, lag, logLik, AIC, BIC, RMSE, MAE, MASE, ACF1)) %>% 
  arrange(xvar, AIC)
gla_s 


gla_s <- map_dfr(arimax_and_fcs_auto$all_arimax$arimax, sw_glance)
gla_s$model.desc <- NULL
gla_s$xvar <- arimax_and_fcs_auto$all_arimax$id_fc
gla_s$lag <- arimax_and_fcs_auto$all_arimax$lag
gla_s <- gla_s %>%  
  select(c(xvar, lag, logLik, AIC, BIC, RMSE, MAE, MASE, ACF1)) %>% 
  arrange(xvar, AIC)
gla_s 

swe_s <-  map2(arimax_and_fcs_auto$all_arimax$arimax,
               arimax_and_fcs_auto$all_arimax$id_fc,
               ~ tidy(.x,  conf.int = TRUE) %>% mutate(id = .y))  %>% 
  reduce(rbind)


swe_s

mfcyoy_s <- reduce(arimax_and_fcs_auto$all_fcs$yoy_raw_rgdp_fc, ts.union)
colnames(mfcyoy_s) <- paste("model", 1:ncol(mfcyoy_s), sep = "_")

mrfcyoy_s <- ts.union(make_yoy_ts(rgdp_and_uncond_fc_auto, is_log = TRUE), mfcyoy_s)
colnames(mrfcyoy_s) <- c("uncond", colnames(mfcyoy_s))
mrfcyoy_s
autoplot(mrfcyoy_s)


mfc_s <- reduce(arimax_and_fcs_auto$all_fcs$raw_rgdp_fc, ts.union)
colnames(mfc_s) <- paste("model", 1:ncol(mfc_s), sep = "_")

mrfc_s <- ts.union(rgdp_and_uncond_fc_auto, mfc_s)
colnames(mrfc_s) <- c("uncond", colnames(mfc_s))
mrfc_s
autoplot(mrfc_s)


tsb_mfc_s <- as_tsibble(mfc_s)
tsb_mfc_s
```

```{r manual_arimax_igae_dm_r}


this_xvar <- internal_mdata_ext_ts_dm_r

y_start <-  stats::start(this_rgdp_ts)
y_end <-  stats::end(this_rgdp_ts)
x_start <-  stats::start(this_xvar)
x_end <-  stats::end(this_xvar)

if (time(y_start) > time(x_start)) {
  max_start <- y_start
  } else {
    max_start <- x_start
  } 

if (time(y_end) < time(x_end)) {
  min_end <- y_end
  } else {
    min_end <- x_end
  } 

ix0 <- map(seq(0,0), ~ lag.xts(this_xvar, k = .)) %>% 
  reduce(ts.union)
colnames(ix0) <- paste(colnames(this_xvar), seq(0,0), sep = "_")

ix1 <- map(seq(0,1), ~ lag.xts(this_xvar, k = .)) %>% 
  reduce(ts.union)
colnames(ix1) <- paste(colnames(this_xvar), seq(0,1), sep = "_")

ix2 <- map(seq(0,2), ~ lag.xts(this_xvar, k = .)) %>% 
  reduce(ts.union)
colnames(ix2) <- paste(colnames(this_xvar), seq(0,2), sep = "_")

procrustean_ym <- window(this_rgdp_ts, start = max_start, end = min_end)
procrustean_x0 <- window(ix0, start = max_start, end = min_end)
procrustean_x1 <- window(ix1, start = max_start, end = min_end)
procrustean_x2 <- window(ix2, start = max_start, end = min_end)

manu_arimax_igae0 <- Arima(y = procrustean_ym, xreg = procrustean_x0,
                           order = rgdp_order_list_dm_r$order,
                           seasonal = rgdp_order_list_dm_r$seasonal,
                           include.constant = rgdp_order_list_dm_r$mean_logical,
                           method = "ML")

manu_arimax_igae1 <- Arima(y = procrustean_ym, xreg = procrustean_x1,
                           order = rgdp_order_list_dm_r$order,
                           seasonal = rgdp_order_list_dm_r$seasonal,
                           include.constant = rgdp_order_list_dm_r$mean_logical,
                           method = "ML")


manu_arimax_igae2 <- Arima(y = procrustean_ym, xreg = procrustean_x2,
                           order = rgdp_order_list_dm_r$order,
                           seasonal = rgdp_order_list_dm_r$seasonal,
                           include.constant = rgdp_order_list_dm_r$mean_logical,
                           method = "ML")

fc_start = stats::start(rgdp_uncond_fc_mean)
ix0_fc <- window(ix0, start = fc_start)
ix1_fc <- window(ix1, start = fc_start)
ix2_fc <- window(ix2, start = fc_start)

manu_fc_igae0 <- forecast(manu_arimax_igae0, h = 9, xreg = ix0_fc)
manu_fc_igae1 <- forecast(manu_arimax_igae1, h = 9, xreg = ix1_fc)
manu_fc_igae2 <- forecast(manu_arimax_igae2, h = 9, xreg = ix2_fc)

foo <- autoplot(manu_fc_igae0, PI = FALSE) + 
  autolayer(manu_fc_igae1, PI = FALSE) + 
  autolayer(manu_fc_igae2, PI = FALSE) + 
  autolayer(rgdp_and_uncond_fc_dm_nf) + 
  coord_cartesian(xlim = c(2016, 2020))

fc_igae0_and_data <- ts(c(manu_fc_igae0$x, manu_fc_igae0$mean), frequency = 4,
                        start = stats::start(manu_fc_igae0$x))
fc_yoy_igae0_and_data <- make_yoy_ts(fc_igae0_and_data , is_log = TRUE)

fc_igae1_and_data <- ts(c(manu_fc_igae1$x, manu_fc_igae0$mean), frequency = 4,
                        start = stats::start(manu_fc_igae1$x))
fc_yoy_igae1_and_data <- make_yoy_ts(fc_igae1_and_data , is_log = TRUE)

fc_igae2_and_data <- ts(c(manu_fc_igae2$x, manu_fc_igae0$mean), frequency = 4,
                        start = stats::start(manu_fc_igae2$x))
fc_yoy_igae2_and_data <- make_yoy_ts(fc_igae2_and_data , is_log = TRUE)


igae0_gr <- seas_yr_growth(fc_igae0_and_data, is_log = TRUE, freq = 4)
igae1_gr <- seas_yr_growth(fc_igae1_and_data, is_log = TRUE, freq = 4)
igae2_gr <- seas_yr_growth(fc_igae2_and_data, is_log = TRUE, freq = 4)

q_igae0_gr <- igae0_gr$seasonal_growth  %>% select(index, gr) %>% 
  rename(igae0_gr = gr)
q_igae1_gr <- igae1_gr$seasonal_growth  %>% select(index, gr) %>% 
  rename(igae1_gr = gr) 
q_igae2_gr <- igae2_gr$seasonal_growth  %>% select(index, gr) %>% 
  rename(igae2_gr = gr) 
q_rgdp_gr <- rgdp_ext_gr_dm_nf$seasonal_growth  %>% select(index, gr) %>% 
  rename(rgdp_gr = gr)

y_igae0_gr <- igae0_gr$year_growth  %>% select(year_index, y_ave_gr) %>% 
  rename(igae0_gr = y_ave_gr) 
y_igae1_gr <- igae1_gr$year_growth  %>% select(year_index, y_ave_gr) %>% 
  rename(igae1_gr = y_ave_gr) 
y_igae2_gr <- igae2_gr$year_growth  %>% select(year_index, y_ave_gr) %>% 
  rename(igae2_gr = y_ave_gr) 
y_rgdp_gr <- rgdp_ext_gr_dm_nf$year_growth  %>% select(year_index, y_ave_gr) %>% 
  rename(rgdp_gr = y_ave_gr)

quarter_gr_un_con_dm_r <- left_join(q_rgdp_gr, q_igae0_gr, by = "index") %>% 
  left_join(q_igae1_gr, by = "index") %>% 
  left_join(q_igae2_gr, by = "index") 

tail(quarter_gr_un_con_dm_r, n = 12)

# rgdp_ext_gr_auto
# rgdp_ext_gr_dm_f
# rgdp_ext_gr_dm_nf


fooyoy <- autoplot(fc_yoy_igae0_and_data, series = "igae0") + 
  autolayer(fc_yoy_igae1_and_data) + 
  autolayer(fc_yoy_igae2_and_data) + 
  autolayer(make_yoy_ts(rgdp_and_uncond_fc_dm_nf, is_log = TRUE)) + 
  coord_cartesian(xlim = c(2016, 2020))

fooyoy2 <- autoplot(fc_yoy_igae0_and_data, series = "igae0") + 
  autolayer(make_yoy_ts(rgdp_and_uncond_fc_dm_nf, is_log = TRUE)) + 
  coord_cartesian(xlim = c(2016, 2020))
# 
# manu_arimax_igae0
# manu_arimax_igae1
# manu_arimax_igae2
# 
# ix0_fc
# ix1_fc
# ix2_fc
# 
# 
# 
# ix0
# ix1
# ix2

```


```{r manual_arimax_igae_auto}


this_xvar <- internal_mdata_ext_ts_auto

y_start <-  stats::start(this_rgdp_ts)
y_end <-  stats::end(this_rgdp_ts)
x_start <-  stats::start(this_xvar)
x_end <-  stats::end(this_xvar)

if (time(y_start) > time(x_start)) {
  max_start <- y_start
  } else {
    max_start <- x_start
  } 

if (time(y_end) < time(x_end)) {
  min_end <- y_end
  } else {
    min_end <- x_end
  } 

ix0 <- map(seq(0,0), ~ lag.xts(this_xvar, k = .)) %>% 
  reduce(ts.union)
colnames(ix0) <- paste(colnames(this_xvar), seq(0,0), sep = "_")

ix1 <- map(seq(0,1), ~ lag.xts(this_xvar, k = .)) %>% 
  reduce(ts.union)
colnames(ix1) <- paste(colnames(this_xvar), seq(0,1), sep = "_")

ix2 <- map(seq(0,2), ~ lag.xts(this_xvar, k = .)) %>% 
  reduce(ts.union)
colnames(ix2) <- paste(colnames(this_xvar), seq(0,2), sep = "_")

procrustean_y <- window(this_rgdp_ts, start = max_start, end = min_end)
procrustean_x0 <- window(ix0, start = max_start, end = min_end)
procrustean_x1 <- window(ix1, start = max_start, end = min_end)
procrustean_x2 <- window(ix2, start = max_start, end = min_end)

manu_arimax_igae0 <- Arima(y = procrustean_y, xreg = procrustean_x0,
                           order = rgdp_order_list_auto$order,
                           seasonal = rgdp_order_list_auto$seasonal,
                           include.constant = rgdp_order_list_auto$mean_logical,
                           method = "ML")

manu_arimax_igae1 <- Arima(y = procrustean_y, xreg = procrustean_x1,
                           order = rgdp_order_list_auto$order,
                           seasonal = rgdp_order_list_auto$seasonal,
                           include.constant = rgdp_order_list_auto$mean_logical,
                           method = "ML")


manu_arimax_igae2 <- Arima(y = procrustean_y, xreg = procrustean_x2,
                           order = rgdp_order_list_auto$order,
                           seasonal = rgdp_order_list_auto$seasonal,
                           include.constant = rgdp_order_list_auto$mean_logical,
                           method = "ML")
# 
# 
# manu_arimax_igae0
# manu_arimax_igae1
# manu_arimax_igae2


fc_start = stats::start(rgdp_uncond_fc_mean)
ix0_fc <- window(ix0, start = fc_start)
ix1_fc <- window(ix1, start = fc_start)
ix2_fc <- window(ix2, start = fc_start)

manu_fc_igae0 <- forecast(manu_arimax_igae0, h = 9, xreg = ix0_fc)
manu_fc_igae1 <- forecast(manu_arimax_igae1, h = 9, xreg = ix1_fc)
manu_fc_igae2 <- forecast(manu_arimax_igae2, h = 9, xreg = ix2_fc)

foo <- autoplot(manu_fc_igae0, PI = FALSE) + 
  autolayer(manu_fc_igae1, PI = FALSE) + 
  autolayer(manu_fc_igae2, PI = FALSE) + 
  autolayer(rgdp_and_uncond_fc_auto) + 
  coord_cartesian(xlim = c(2016, 2020))

fc_igae0_and_data <- ts(c(manu_fc_igae0$x, manu_fc_igae0$mean), frequency = 4,
                        start = stats::start(manu_fc_igae0$x))
fc_yoy_igae0_and_data <- make_yoy_ts(fc_igae0_and_data , is_log = TRUE)

fc_igae1_and_data <- ts(c(manu_fc_igae1$x, manu_fc_igae0$mean), frequency = 4,
                        start = stats::start(manu_fc_igae1$x))
fc_yoy_igae1_and_data <- make_yoy_ts(fc_igae1_and_data , is_log = TRUE)

fc_igae2_and_data <- ts(c(manu_fc_igae2$x, manu_fc_igae0$mean), frequency = 4,
                        start = stats::start(manu_fc_igae2$x))
fc_yoy_igae2_and_data <- make_yoy_ts(fc_igae2_and_data , is_log = TRUE)


igae0_gr <- seas_yr_growth(fc_igae0_and_data, is_log = TRUE, freq = 4)
igae1_gr <- seas_yr_growth(fc_igae1_and_data, is_log = TRUE, freq = 4)
igae2_gr <- seas_yr_growth(fc_igae2_and_data, is_log = TRUE, freq = 4)

q_igae0_gr <- igae0_gr$seasonal_growth  %>% select(index, gr) %>% 
  rename(igae0_gr = gr)
q_igae1_gr <- igae1_gr$seasonal_growth  %>% select(index, gr) %>% 
  rename(igae1_gr = gr) 
q_igae2_gr <- igae2_gr$seasonal_growth  %>% select(index, gr) %>% 
  rename(igae2_gr = gr) 
q_rgdp_gr <- rgdp_ext_gr_auto$seasonal_growth  %>% select(index, gr) %>% 
  rename(rgdp_gr = gr)

y_igae0_gr <- igae0_gr$year_growth  %>% select(year_index, y_ave_gr) %>% 
  rename(igae0_gr = y_ave_gr) 
y_igae1_gr <- igae1_gr$year_growth  %>% select(year_index, y_ave_gr) %>% 
  rename(igae1_gr = y_ave_gr) 
y_igae2_gr <- igae2_gr$year_growth  %>% select(year_index, y_ave_gr) %>% 
  rename(igae2_gr = y_ave_gr) 
y_rgdp_gr <- rgdp_ext_gr_auto$year_growth  %>% select(year_index, y_ave_gr) %>% 
  rename(rgdp_gr = y_ave_gr)

quarter_gr_un_con_auto <- left_join(q_rgdp_gr, q_igae0_gr, by = "index") %>% 
  left_join(q_igae1_gr, by = "index") %>% 
  left_join(q_igae2_gr, by = "index") 

tail(quarter_gr_un_con_auto, n = 12)

# rgdp_ext_gr_auto
# rgdp_ext_gr_dm_f
# rgdp_ext_gr_dm_nf


fooyoy <- autoplot(fc_yoy_igae0_and_data, series = "igae0") + 
  autolayer(fc_yoy_igae1_and_data) + 
  autolayer(fc_yoy_igae2_and_data) + 
  autolayer(make_yoy_ts(rgdp_and_uncond_fc_dm_nf, is_log = TRUE)) + 
  coord_cartesian(xlim = c(2016, 2020))

fooyoy2 <- autoplot(fc_yoy_igae0_and_data, series = "igae0") + 
  autolayer(make_yoy_ts(rgdp_and_uncond_fc_dm_nf, is_log = TRUE)) + 
  coord_cartesian(xlim = c(2016, 2020))


# ix0_fc
# ix1_fc
# ix2_fc

# 
# 
# ix0
# ix1
# ix2

```


```{r manual_arimax_igae_dm_s}


this_xvar <- internal_mdata_ext_ts_dm_s

y_start <-  stats::start(this_rgdp_ts)
y_end <-  stats::end(this_rgdp_ts)
x_start <-  stats::start(this_xvar)
x_end <-  stats::end(this_xvar)

if (time(y_start) > time(x_start)) {
  max_start <- y_start
  } else {
    max_start <- x_start
  } 

if (time(y_end) < time(x_end)) {
  min_end <- y_end
  } else {
    min_end <- x_end
  } 


ix0 <- map(seq(0,0), ~ lag.xts(this_xvar, k = .)) %>% 
  reduce(ts.union)
colnames(ix0) <- paste(colnames(this_xvar), seq(0,0), sep = "_")

ix1 <- map(seq(0,1), ~ lag.xts(this_xvar, k = .)) %>% 
  reduce(ts.union)
colnames(ix1) <- paste(colnames(this_xvar), seq(0,1), sep = "_")

ix2 <- map(seq(0,2), ~ lag.xts(this_xvar, k = .)) %>% 
  reduce(ts.union)
colnames(ix2) <- paste(colnames(this_xvar), seq(0,2), sep = "_")





procrustean_ym <- window(this_rgdp_ts, start = max_start, end = min_end)
procrustean_x0 <- window(ix0, start = max_start, end = min_end)
procrustean_x1 <- window(ix1, start = max_start, end = min_end)
procrustean_x2 <- window(ix2, start = max_start, end = min_end)


xtrend <- seq(1, length(procrustean_ym))^2


procrustean_x0_and_trend <- ts.union(procrustean_x0, xtrend)
colnames(procrustean_x0_and_trend) <- c(colnames(procrustean_x0), "trend")

procrustean_x1_and_trend <- ts.union(procrustean_x1, xtrend)
colnames(procrustean_x1_and_trend) <- c(colnames(procrustean_x1), "trend")

procrustean_x2_and_trend <- ts.union(procrustean_x2, xtrend)
colnames(procrustean_x2_and_trend) <- c(colnames(procrustean_x2), "trend")

manu_arimax_igae0 <- Arima(y = procrustean_ym, xreg = procrustean_x0_and_trend,
                           order = rgdp_order_list_auto$order,
                           seasonal = rgdp_order_list_auto$seasonal,
                           include.constant = rgdp_order_list_auto$mean_logical,
                           method = "ML")

manu_arimax_igae1 <- Arima(y = procrustean_ym, xreg = procrustean_x1_and_trend,
                           order = rgdp_order_list_auto$order,
                           seasonal = rgdp_order_list_auto$seasonal,
                           include.constant = rgdp_order_list_auto$mean_logical,
                           method = "ML")


manu_arimax_igae2 <- Arima(y = procrustean_ym, xreg = procrustean_x2_and_trend,
                           order = rgdp_order_list_auto$order,
                           seasonal = rgdp_order_list_auto$seasonal,
                           include.constant = rgdp_order_list_auto$mean_logical,
                           method = "ML")


manu_arimax_igae0
manu_arimax_igae1
manu_arimax_igae2


fc_start = stats::start(rgdp_uncond_fc_mean)
ix0_fc <- window(ix0, start = fc_start)
ix1_fc <- window(ix1, start = fc_start)
ix2_fc <- window(ix2, start = fc_start)
xtrend_fc <- seq(length(procrustean_y) + 1, 
                 length(procrustean_y) + length(ix0_fc))^2

ix0_fc_and_trend <- ts.union(ix0_fc, xtrend_fc)
ix1_fc_and_trend <- ts.union(ix1_fc, xtrend_fc)
ix2_fc_and_trend <- ts.union(ix2_fc, xtrend_fc)


manu_fc_igae0 <- forecast(manu_arimax_igae0, h = 9, xreg = ix0_fc_and_trend)
manu_fc_igae1 <- forecast(manu_arimax_igae1, h = 9, xreg = ix1_fc_and_trend)
manu_fc_igae2 <- forecast(manu_arimax_igae2, h = 9, xreg = ix2_fc_and_trend)

foo <- autoplot(manu_fc_igae0, PI = FALSE) + 
  autolayer(manu_fc_igae1, PI = FALSE) + 
  autolayer(manu_fc_igae2, PI = FALSE) + 
  autolayer(rgdp_and_uncond_fc_auto) + 
  coord_cartesian(xlim = c(2016, 2020))

fc_igae0_and_data <- ts(c(manu_fc_igae0$x, manu_fc_igae0$mean), frequency = 4,
                        start = stats::start(manu_fc_igae0$x))
fc_yoy_igae0_and_data <- make_yoy_ts(fc_igae0_and_data , is_log = TRUE)

fc_igae1_and_data <- ts(c(manu_fc_igae1$x, manu_fc_igae0$mean), frequency = 4,
                        start = stats::start(manu_fc_igae1$x))
fc_yoy_igae1_and_data <- make_yoy_ts(fc_igae1_and_data , is_log = TRUE)

fc_igae2_and_data <- ts(c(manu_fc_igae2$x, manu_fc_igae0$mean), frequency = 4,
                        start = stats::start(manu_fc_igae2$x))
fc_yoy_igae2_and_data <- make_yoy_ts(fc_igae2_and_data , is_log = TRUE)


igae0_gr <- seas_yr_growth(fc_igae0_and_data, is_log = TRUE, freq = 4)
igae1_gr <- seas_yr_growth(fc_igae1_and_data, is_log = TRUE, freq = 4)
igae2_gr <- seas_yr_growth(fc_igae2_and_data, is_log = TRUE, freq = 4)

q_igae0_gr <- igae0_gr$seasonal_growth  %>% select(index, gr) %>% 
  rename(igae0_gr = gr)
q_igae1_gr <- igae1_gr$seasonal_growth  %>% select(index, gr) %>% 
  rename(igae1_gr = gr) 
q_igae2_gr <- igae2_gr$seasonal_growth  %>% select(index, gr) %>% 
  rename(igae2_gr = gr) 
q_rgdp_gr <- rgdp_ext_gr_dm_f$seasonal_growth  %>% select(index, gr) %>% 
  rename(rgdp_gr = gr)

y_igae0_gr <- igae0_gr$year_growth  %>% select(year_index, y_ave_gr) %>% 
  rename(igae0_gr = y_ave_gr) 
y_igae1_gr <- igae1_gr$year_growth  %>% select(year_index, y_ave_gr) %>% 
  rename(igae1_gr = y_ave_gr) 
y_igae2_gr <- igae2_gr$year_growth  %>% select(year_index, y_ave_gr) %>% 
  rename(igae2_gr = y_ave_gr) 
y_rgdp_gr <- rgdp_ext_gr_dm_f$year_growth  %>% select(year_index, y_ave_gr) %>% 
  rename(rgdp_gr = y_ave_gr)

quarter_gr_un_con_dm_s <- left_join(q_rgdp_gr, q_igae0_gr, by = "index") %>% 
  left_join(q_igae1_gr, by = "index") %>% 
  left_join(q_igae2_gr, by = "index") 

tail(quarter_gr_un_con_dm_s, n = 12)

# rgdp_ext_gr_auto
# rgdp_ext_gr_dm_f
# rgdp_ext_gr_dm_nf


fooyoy <- autoplot(fc_yoy_igae0_and_data, series = "igae0") + 
  autolayer(fc_yoy_igae1_and_data) + 
  autolayer(fc_yoy_igae2_and_data) + 
  autolayer(make_yoy_ts(rgdp_and_uncond_fc_dm_nf, is_log = TRUE)) + 
  coord_cartesian(xlim = c(2016, 2020))

fooyoy2 <- autoplot(fc_yoy_igae0_and_data, series = "igae0") + 
  autolayer(make_yoy_ts(rgdp_and_uncond_fc_dm_nf, is_log = TRUE)) + 
  coord_cartesian(xlim = c(2016, 2020))


# ix0_fc
# ix1_fc
# ix2_fc


# 
# ix0
# ix1
# ix2

```


```{r comparing_full_size_manual_arimax}
tail(quarter_gr_un_con_dm_s, n = 12)
tail(quarter_gr_un_con_dm_r, n = 12)
tail(quarter_gr_un_con_auto, n = 12)
```

```{r arimax_fun_dm_r}

tic()
arimax_and_fcs <- get_arimax_and_fcs(y_ts = this_rgdp_ts, 
                          xreg_ts = mdata_ext_ts_dm_r,
                          rgdp_arima = this_rgdp_arima_dm_r,
                          max_x_lag = max_x_lag,
                          rgdp_order_list = rgdp_order_list_dm_r,
                          h_max = h_max)
toc()

all_arimax_tbl <- arimax_and_fcs$all_arimax

# igae_0
all_arimax_tbl$arimax[[1]]
manu_arimax_igae0

all_arimax_tbl$arimax[[1]]$x
manu_arimax_igae0$x

all_arimax_tbl$arimax[[1]]$xreg
manu_arimax_igae0$xreg

all_arimax_tbl$arimax[[1]]$arma
manu_arimax_igae0$arma

all_arimax_tbl$arimax[[1]]$call
manu_arimax_igae0$call

```

```{r arimax_fun_dm_s}

tic()
arimax_and_fcs <- get_arimax_and_fcs(y_ts = this_rgdp_ts, 
                          xreg_ts = mdata_ext_ts_dm_s,
                          rgdp_arima = this_rgdp_arima_dm_s,
                          max_x_lag = max_x_lag,
                          rgdp_order_list = rgdp_order_list_dm_s,
                          h_max = h_max, force.constant = TRUE)
toc()

all_arimax_tbl <- arimax_and_fcs$all_arimax

# igae_0
all_arimax_tbl$arimax[[1]]
manu_arimax_igae0

all_arimax_tbl$arimax[[1]]$x
manu_arimax_igae0$x

all_arimax_tbl$arimax[[1]]$xreg
manu_arimax_igae0$xreg

all_arimax_tbl$arimax[[1]]$arma
manu_arimax_igae0$arma

all_arimax_tbl$arimax[[1]]$call
manu_arimax_igae0$call

```


```{r arimax_fun_auto}

tic()
arimax_and_fcs <- get_arimax_and_fcs(y_ts = this_rgdp_ts, 
                          xreg_ts = mdata_ext_ts_auto,
                          rgdp_arima = this_rgdp_arima_auto,
                          max_x_lag = max_x_lag,
                          rgdp_order_list = rgdp_order_list_auto,
                          h_max = h_max)
toc()

all_arimax_tbl <- arimax_and_fcs$all_arimax

# igae_0
all_arimax_tbl$arimax[[1]]
manu_arimax_igae0

all_arimax_tbl$arimax[[1]]$x
manu_arimax_igae0$x

all_arimax_tbl$arimax[[1]]$xreg
manu_arimax_igae0$xreg

all_arimax_tbl$arimax[[1]]$arma
manu_arimax_igae0$arma

all_arimax_tbl$arimax[[1]]$call
manu_arimax_igae0$call

```


## Cross Validation

```{r cv_fun_auto}

tic()
cv_cond_uncond_auto <- get_cv_obj_cond_uncond(y_ts = this_rgdp_ts, 
                              xreg_ts = mdata_ext_ts_auto,
                              rgdp_arima = this_rgdp_arima_auto,
                              max_x_lag = max_x_lag,
                              rgdp_order_list = rgdp_order_list_auto,
                              n_cv = number_of_cv, 
                              test_length = test_length,
                              training_length = train_span,
                              h_max = h_max, data_is_log_log = TRUE)
toc()

```


```{r cv_fun_dm_r}

tic()
cv_cond_uncond_dm_r <- get_cv_obj_cond_uncond(y_ts = this_rgdp_ts, 
                              xreg_ts = mdata_ext_ts_dm_r,
                              rgdp_arima = this_rgdp_arima_dm_r,
                              max_x_lag = max_x_lag,
                              rgdp_order_list = rgdp_order_list_dm_r,
                              n_cv = number_of_cv, 
                              test_length = test_length,
                              training_length = train_span,
                              h_max = h_max, data_is_log_log = TRUE)
toc()

```


```{r cv_fun_dm_s}

tic()
cv_cond_uncond_dm_s <- get_cv_obj_cond_uncond(y_ts = this_rgdp_ts, 
                              xreg_ts = mdata_ext_ts_dm_s,
                              rgdp_arima = this_rgdp_arima_dm_s,
                              max_x_lag = max_x_lag,
                              rgdp_order_list = rgdp_order_list_dm_s,
                              n_cv = number_of_cv, 
                              test_length = test_length,
                              training_length = train_span,
                              h_max = h_max, data_is_log_log = TRUE, 
                              force.constant = TRUE)
toc()

```

